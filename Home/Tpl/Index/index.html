<!DOCTYPE html>
<html>
<head>
	<title>asdf</title>
    <link href='__PUBLIC__/plugins/font-awesome/css/font-awesome.min.css' rel="stylesheet" type="text/css" />
    <link href='__PUBLIC__/plugins/bootstrap/css/bootstrap.min.css' rel="stylesheet" type="text/css" />
    <link href="../Public/css/index.css" rel="stylesheet" type="text/css" />
</head>
<body class="indexPage">
	<div class="header">
		<div>{$Think.session.username} [&nbsp;<a href="javascript:void(0)" onclick="logout()" id="logoutLink" class="left-font01">退出</a>&nbsp;]</div>
        <div><a href="{:U('Columns/index')}">类目</a></div>
        <div><a href="{:U('Tables/index')}">我的表</a></div>
        <div><a href="{:U('Map/index')}">表映射</a></div>
        <div><a href="{:U('Upload/index')}">上传数据</a></div>
	</div>
	<div class="content">
        <volist name='tblist' id="tb">
            <div id='chart{$tb[id]}'></div>
        </volist>
        <div id="container"></div>
        <div>我的数据</div>
        <table class="table table-bordered table-hover">
            <thead>
                <th>id</th>
                <th>Table Name</th>
                <th>Class Id</th>
                <th>所属分类</th>
                <th>列名</th>
                <th>值</th>
                <th>备注</th>
                <th>时间</th>
                <th>填写时间</th>
                <th colspan="2">Setting</th>
            </thead>
            <tbody>
                <volist name='tables' id="table">
                    <tr>
                        <td>{$table[id]}</td>
                        <td>{$table[tablename]}</td>
                        <td>{$table[cid]}</td>
                        <td>{$table[mclass]}</td>
                        <td>{$table[name]}</td>
                        <td>{$table[value]}</td>
                        <td>{$table[notes]}</td>
                        <td>{$table[time]}</td>
                        <td>{$table[ctime]}</td>
                        <td><a href="{:U('edit')}/id/{$table[dataId]}/cid/{$table[cid]}">Edit</a></td>
                        <td><a href="{:U('delete')}/id/{$table[dataId]}">Delete</a></td>
                    </tr>
                </volist>
            </tbody>
        </table>
        <div><a href="{:U('add')}" class="left-font01">添加数据</a></div>
	</div>
</body>
<script src='__PUBLIC__/plugins/jquery/jquery.min.js'></script>
<!-- <script src='__PUBLIC__/plugins/highcharts/jquery-1.8.3.min.js'></script> -->
<script src='__PUBLIC__/plugins/bootstrap/js/bootstrap.min.js'></script>
<script src="__PUBLIC__/plugins/underscore/underscore-min.js"></script>
<!-- <script src='__PUBLIC__/plugins/highcharts/jquery-1.8.3.min.js'></script> -->
<!-- <script src="__PUBLIC__/plugins/highcharts/highcharts.js"></script> -->
<script src="https://code.highcharts.com/highcharts.src.js"></script>
<script src="__PUBLIC__/plugins/highcharts/exporting.js"></script>
<script src="__PUBLIC__/plugins/highcharts/highcharts-zh_CN.js"></script>
<script>
$(function() {   	
    var data = null;
    var tables = null;
	$("#logoutLink").click(function(){
        $.ajax({
            url:"{:U('Login/logout')}",
            type:'get',
            success:function(result){
                if(result.status){
                    window.location.href="{:U('Login/index')}"; 
                }else{
                    alert("Logout failed!");
                }
            }
        })      		
	})

    $.ajax({
        url:"{:U('getDate')}",
        type:'get',
        success:function(result){
            data = result.data;
            tables = result.tables;
            tables.forEach(function(table){
                var chartData = [];
                var chartCol = [];
                var chartColId = [];
                var series = [];
                data.forEach(function(val){
                    if(val.id === table.id) {
                        chartData.push(val);
                        chartCol.push(val.name);
                        chartColId.push(val.cid);
                    }
                });
                chartColName = _.uniq(chartCol);
                chartColId = _.uniq(chartColId);
                chartColId.forEach(function(col,colIndex){
                    var itemData = [];
                    chartData.forEach(function(itemDataItem){
                        if(itemDataItem.cid === col){
                            var temp = [
                                parseFloat(itemDataItem.time)*1000,
                                parseFloat(itemDataItem.value)
                            ];
                            itemData.push(temp);                            
                        }
                    })
                    var chartItem = {
                        name: chartColName[colIndex],
                        data: itemData
                    }
                    series.push(chartItem);
                })

                var chart1 = Highcharts.chart('chart'+table.id, {
                    chart: {
                        type: 'spline'
                    },
                    title: {
                        text: table.tablename
                    },
                    subtitle: {
                        text: null
                    },
                    xAxis: {
                        title: {
                            text: null
                        },
                        type: "datetime"
                        labels: {
                                format: '{value: %Y%m%d}'
                        }
                    },
                    yAxis: {
                        title: {
                            text: null
                        },
                        min: 0
                    },
                    tooltip: {
                        split: true
                    },
                    plotOptions: {
                        spline: {
                            marker: {
                                enabled: true
                            }
                        }
                    },
                    series: series
                });
            })
        }
    })    
});
</script>
</html>